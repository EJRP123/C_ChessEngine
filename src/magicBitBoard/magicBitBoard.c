#include "MagicBitBoard.h"
#include "Rook.h"
#include "Bishop.h"
#include <stdlib.h>

u64 rookMovementMask[BOARD_SIZE] = {282578800148862UL, 565157600297596UL, 1130315200595066UL, 2260630401190006UL, 4521260802379886UL, 9042521604759646UL, 18085043209519166UL, 36170086419038334UL, 282578800180736UL, 565157600328704UL, 1130315200625152UL, 2260630401218048UL, 4521260802403840UL, 9042521604775424UL, 18085043209518592UL, 36170086419037696UL, 282578808340736UL, 565157608292864UL, 1130315208328192UL, 2260630408398848UL, 4521260808540160UL, 9042521608822784UL, 18085043209388032UL, 36170086418907136UL, 282580897300736UL, 565159647117824UL, 1130317180306432UL, 2260632246683648UL, 4521262379438080UL, 9042522644946944UL, 18085043175964672UL, 36170086385483776UL, 283115671060736UL, 565681586307584UL, 1130822006735872UL, 2261102847592448UL, 4521664529305600UL, 9042787892731904UL, 18085034619584512UL, 36170077829103616UL, 420017753620736UL, 699298018886144UL, 1260057572672512UL, 2381576680245248UL, 4624614895390720UL, 9110691325681664UL, 18082844186263552UL, 36167887395782656UL, 35466950888980736UL, 34905104758997504UL, 34344362452452352UL, 33222877839362048UL, 30979908613181440UL, 26493970160820224UL, 17522093256097792UL, 35607136465616896UL, 9079539427579068672UL, 8935706818303361536UL, 8792156787827803136UL, 8505056726876686336UL, 7930856604974452736UL, 6782456361169985536UL, 4485655873561051136UL, 9115426935197958144UL};

u64 bishopMovementMask[BOARD_SIZE] = {18049651735527936UL, 70506452091904UL, 275415828992UL, 1075975168UL, 38021120UL, 8657588224UL, 2216338399232UL, 567382630219776UL, 9024825867763712UL, 18049651735527424UL, 70506452221952UL, 275449643008UL, 9733406720UL, 2216342585344UL, 567382630203392UL, 1134765260406784UL, 4512412933816832UL, 9024825867633664UL, 18049651768822272UL, 70515108615168UL, 2491752130560UL, 567383701868544UL, 1134765256220672UL, 2269530512441344UL, 2256206450263040UL, 4512412900526080UL, 9024834391117824UL, 18051867805491712UL, 637888545440768UL, 1135039602493440UL, 2269529440784384UL, 4539058881568768UL, 1128098963916800UL, 2256197927833600UL, 4514594912477184UL, 9592139778506752UL, 19184279556981248UL, 2339762086609920UL, 4538784537380864UL, 9077569074761728UL, 562958610993152UL, 1125917221986304UL, 2814792987328512UL, 5629586008178688UL, 11259172008099840UL, 22518341868716544UL, 9007336962655232UL, 18014673925310464UL, 2216338399232UL, 4432676798464UL, 11064376819712UL, 22137335185408UL, 44272556441600UL, 87995357200384UL, 35253226045952UL, 70506452091904UL, 567382630219776UL, 1134765260406784UL, 2832480465846272UL, 5667157807464448UL, 11333774449049600UL, 22526811443298304UL, 9024825867763712UL, 18049651735527936UL};

u64 rookMagics[BOARD_SIZE] = {36029347179544577UL, 2323857689312190466UL, 468391962559383680UL, 4647723613687148546UL, 144132919915577352UL, 648522744522244352UL, 144125360773136392UL, 4647715914997842048UL, 1729804540244410370UL, 290623050896901252UL, 281820184772672UL, 153263193546823680UL, 1153202997048653824UL, 18577915499268112UL, 9670354338970871824UL, 9368050179246163014UL, 36029072970620928UL, 4929331630230799393UL, 4611757486957920512UL, 37437271952064602UL, 72622743149872160UL, 4612390256866511872UL, 37317424915253250UL, 2306131081370009953UL, 36032384390406144UL, 13511079128784900UL, 576548715383226496UL, 9259972582076059648UL, 1152930302849712256UL, 1145693272015872UL, 9232528855590437392UL, 8075095008950108416UL, 4621221258149757070UL, 599404262614641152UL, 864512508960768UL, 153263193546823680UL, 1153202997048653824UL, 18577915499268112UL, 360571747335934017UL, 282588480536708UL, 4755871610152976384UL, 4611721208436768768UL, 1154082593218560080UL, 35459417899025UL, 1125934275002382UL, 1176002469885411330UL, 288239176808398850UL, 77687454961893377UL, 5260202827150502400UL, 5260202827150502400UL, 5296232809593843200UL, 7007600874156364288UL, 18446743979218685440UL, 18446744030759085568UL, 1125444202439872UL, 5841168673586058912UL, 17005591892296975654UL, 7061642970158444206UL, 6034823423364870562UL, 1333065189051839990UL, 4692750665688806614UL, 3659191877240901UL, 1125827562356340UL, 8522499339677771678UL};
int rookShifts[BOARD_SIZE] = {52, 53, 53, 53, 53, 53, 53, 52, 53, 54, 54, 54, 54, 54, 54, 53, 53, 54, 54, 54, 54, 54, 54, 53, 53, 54, 54, 54, 54, 54, 54, 53, 53, 54, 54, 54, 54, 54, 54, 53, 53, 54, 54, 54, 54, 54, 54, 53, 54, 55, 55, 55, 55, 55, 55, 54, 53, 54, 54, 54, 54, 53, 54, 53};
int rookIndexOffset[BOARD_SIZE] = {0, 4096, 6144, 8192, 10240, 12288, 14336, 16384, 20480, 22528, 23552, 24576, 25600, 26624, 27648, 28672, 30720, 32768, 33792, 34816, 35840, 36864, 37888, 38912, 40960, 43008, 44032, 45056, 46080, 47104, 48128, 49152, 51200, 53248, 54272, 55296, 56320, 57344, 58368, 59392, 61440, 63488, 64512, 65536, 66560, 67584, 68608, 69632, 71680, 72704, 73216, 73728, 74240, 74752, 75264, 75776, 76800, 78848, 79872, 80896, 81920, 82944, 84992, 86016};
#define ROOK_PSEUDO_LEGAL_MOVES_ARRAY_SIZE 88064

u64 bishopMagics[BOARD_SIZE] = {218513711130869762UL, 6055388770491961344UL, 364792128162758914UL, 9228439136761939968UL, 6055388770491961344UL, 2297189028660244UL, 4611835606266282181UL, 2819439938568210UL, 9224661902072479752UL, 5837967233381318660UL, 6055388770491961344UL, 567349074722944UL, 146369324351750168UL, 290491127012790280UL, 11556241050569932960UL, 288248397851525381UL, 11531537493833285632UL, 288248397851525381UL, 45035998431936512UL, 576460756665499648UL, 576460756665499648UL, 45035998431936512UL, 45035998431936512UL, 45035998431936512UL, 79199492638114UL, 432380748671221894UL, 299489650236489857UL, 36031030418739203UL, 792634651117879298UL, 18023744409454608UL, 11556241050569932960UL, 18023744409454608UL, 26674852790913UL, 79199492638114UL, 1450159355967570320UL, 36028835673800752UL, 144117395697696768UL, 11531537493833285632UL, 9223724984400347140UL, 9228439136761939968UL, 290491127012790280UL, 290491127012790280UL, 9223724984400347140UL, 576460756665499648UL, 576460756665499648UL, 5764617154096795660UL, 6055388770491961344UL, 324259742392255496UL, 5260202827150502400UL, 5260202827150502400UL, 5296232809593843200UL, 7007600874156364288UL, 18446743979218685440UL, 18446744030759085568UL, 1125444202439872UL, 5841168673586058912UL, 17005591892296975654UL, 7061642970158444206UL, 6034823423364870562UL, 1333065189051839990UL, 4692750665688806614UL, 9228439136761939968UL, 1125827562356340UL, 8522499339677771678UL};
int bishopShifts[BOARD_SIZE] = {58, 59, 59, 59, 59, 59, 59, 58, 59, 59, 59, 59, 59, 59, 59, 59, 59, 59, 57, 57, 57, 57, 59, 59, 59, 59, 57, 55, 55, 57, 59, 59, 59, 59, 57, 55, 55, 57, 59, 59, 59, 59, 57, 57, 57, 57, 59, 59, 54, 55, 55, 55, 55, 55, 55, 54, 53, 54, 54, 54, 54, 59, 54, 53};
int bishopIndexOffset[BOARD_SIZE] = {0, 64, 96, 128, 160, 192, 224, 256, 320, 352, 384, 416, 448, 480, 512, 544, 576, 608, 640, 768, 896, 1024, 1152, 1184, 1216, 1248, 1280, 1408, 1920, 2432, 2560, 2592, 2624, 2656, 2688, 2816, 3328, 3840, 3968, 4000, 4032, 4064, 4096, 4224, 4352, 4480, 4608, 4640, 4672, 5696, 6208, 6720, 7232, 7744, 8256, 8768, 9792, 11840, 12864, 13888, 14912, 15936, 15968, 16992};
#define BISHOP_PSEUDO_LEGAL_MOVES_ARRAY_SIZE 19040

// The total size of these two arrays is about 800kb
// We don't want that much on the stack so these arrays are allocated on the heap
u64* rookPseudoLegalMovesBitBoard;
u64* bishopPseudoLegalMovesBitBoard;

u64 getRookPseudoLegalMovesBitBoard(int position, u64 blockingBitBoard) {
    u64 magic = rookMagics[position];
    int shift = rookShifts[position];
    u64 key = (blockingBitBoard * magic) >> shift;
    u64 offset = (u64) rookIndexOffset[position];
    u64 indexIntoPseudoLegalMovesArray = offset + key;
    return rookPseudoLegalMovesBitBoard[indexIntoPseudoLegalMovesArray];
}

u64 getBishopPseudoLegalMovesBitBoard(int position, u64 blockingBitBoard) {
    u64 magic = bishopMagics[position];
    int shift = bishopShifts[position];
    u64 key = (blockingBitBoard * magic) >> shift;
    u64 offset = (u64) bishopIndexOffset[position];
    u64 indexIntoPseudoLegalMovesArray = offset + key;
    return bishopPseudoLegalMovesBitBoard[indexIntoPseudoLegalMovesArray];
}

void magicBitBoardInitialize() {
    rookPseudoLegalMovesBitBoard = calloc(ROOK_PSEUDO_LEGAL_MOVES_ARRAY_SIZE, sizeof(u64));
    bishopPseudoLegalMovesBitBoard = calloc(BISHOP_PSEUDO_LEGAL_MOVES_ARRAY_SIZE, sizeof(u64));
    // The max number of valid squares for a piece is 12
    // Thus the max number of blocking bit board 2^12 = 1 << 12
    u64* blockingBitBoards = malloc((1 << 12) * sizeof(u64));
    u64* blockingBitBoardToPseudoLegalMove = malloc((1 << 12) * sizeof(u64));

    // Filling the rook pseudo legal moves bit board array
    for (int position = 0; position < BOARD_SIZE; position++) {
        u64 magic = rookMagics[position];
        int shift = rookShifts[position];
        u64 offset = (u64) rookIndexOffset[position];
        
        int numBlockingBitBoard = 1 << minShiftRook[position];
        fillRookBlockingBitBoardAndPseudoLegalMoveArray(position, blockingBitBoards, blockingBitBoardToPseudoLegalMove);
        for (int i = 0; i < numBlockingBitBoard; i++) {
            u64 blockingBitBoard = blockingBitBoards[i];
            u64 pseudoLegalMovesBitBoard = blockingBitBoardToPseudoLegalMove[i];

            u64 key = (blockingBitBoard * magic) >> shift;
            u64 indexIntoPseudoLegalMovesArray = offset + key;

            u64 nextIndex = position == 63 ? ROOK_PSEUDO_LEGAL_MOVES_ARRAY_SIZE : rookIndexOffset[position + 1];

            rookPseudoLegalMovesBitBoard[indexIntoPseudoLegalMovesArray] = pseudoLegalMovesBitBoard;
        }
    }

    for (int position = 0; position < BOARD_SIZE; position++) {
        u64 magic = bishopMagics[position];
        int shift = bishopShifts[position];
        u64 offset = (u64) bishopIndexOffset[position];
        
        int numBlockingBitBoard = 1 << minShiftBishop[position];
        fillBishopBlockingBitBoardAndPseudoLegalMoveArray(position, blockingBitBoards, blockingBitBoardToPseudoLegalMove);
        for (int i = 0; i < numBlockingBitBoard; i++) {
            u64 blockingBitBoard = blockingBitBoards[i];
            u64 pseudoLegalMovesBitBoard = blockingBitBoardToPseudoLegalMove[i];

            u64 key = (blockingBitBoard * magic) >> shift;
            u64 indexIntoPseudoLegalMovesArray = offset + key;

            bishopPseudoLegalMovesBitBoard[indexIntoPseudoLegalMovesArray] = pseudoLegalMovesBitBoard;
        }
    }
    free(blockingBitBoards);
    free(blockingBitBoardToPseudoLegalMove);
}

void magicBitBoardTerminate() {
    free(rookPseudoLegalMovesBitBoard);
    free(bishopPseudoLegalMovesBitBoard);
}