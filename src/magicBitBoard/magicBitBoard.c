#include "MagicBitBoard.h"
#include "Rook.h"
#include "Bishop.h"
#include <stdlib.h>

u64 rookMovementMask[BOARD_SIZE] = {282578800148862UL, 565157600297596UL, 1130315200595066UL, 2260630401190006UL, 4521260802379886UL, 9042521604759646UL, 18085043209519166UL, 36170086419038334UL, 282578800180736UL, 565157600328704UL, 1130315200625152UL, 2260630401218048UL, 4521260802403840UL, 9042521604775424UL, 18085043209518592UL, 36170086419037696UL, 282578808340736UL, 565157608292864UL, 1130315208328192UL, 2260630408398848UL, 4521260808540160UL, 9042521608822784UL, 18085043209388032UL, 36170086418907136UL, 282580897300736UL, 565159647117824UL, 1130317180306432UL, 2260632246683648UL, 4521262379438080UL, 9042522644946944UL, 18085043175964672UL, 36170086385483776UL, 283115671060736UL, 565681586307584UL, 1130822006735872UL, 2261102847592448UL, 4521664529305600UL, 9042787892731904UL, 18085034619584512UL, 36170077829103616UL, 420017753620736UL, 699298018886144UL, 1260057572672512UL, 2381576680245248UL, 4624614895390720UL, 9110691325681664UL, 18082844186263552UL, 36167887395782656UL, 35466950888980736UL, 34905104758997504UL, 34344362452452352UL, 33222877839362048UL, 30979908613181440UL, 26493970160820224UL, 17522093256097792UL, 35607136465616896UL, 9079539427579068672UL, 8935706818303361536UL, 8792156787827803136UL, 8505056726876686336UL, 7930856604974452736UL, 6782456361169985536UL, 4485655873561051136UL, 9115426935197958144UL};

u64 bishopMovementMask[BOARD_SIZE] = {18049651735527936UL, 70506452091904UL, 275415828992UL, 1075975168UL, 38021120UL, 8657588224UL, 2216338399232UL, 567382630219776UL, 9024825867763712UL, 18049651735527424UL, 70506452221952UL, 275449643008UL, 9733406720UL, 2216342585344UL, 567382630203392UL, 1134765260406784UL, 4512412933816832UL, 9024825867633664UL, 18049651768822272UL, 70515108615168UL, 2491752130560UL, 567383701868544UL, 1134765256220672UL, 2269530512441344UL, 2256206450263040UL, 4512412900526080UL, 9024834391117824UL, 18051867805491712UL, 637888545440768UL, 1135039602493440UL, 2269529440784384UL, 4539058881568768UL, 1128098963916800UL, 2256197927833600UL, 4514594912477184UL, 9592139778506752UL, 19184279556981248UL, 2339762086609920UL, 4538784537380864UL, 9077569074761728UL, 562958610993152UL, 1125917221986304UL, 2814792987328512UL, 5629586008178688UL, 11259172008099840UL, 22518341868716544UL, 9007336962655232UL, 18014673925310464UL, 2216338399232UL, 4432676798464UL, 11064376819712UL, 22137335185408UL, 44272556441600UL, 87995357200384UL, 35253226045952UL, 70506452091904UL, 567382630219776UL, 1134765260406784UL, 2832480465846272UL, 5667157807464448UL, 11333774449049600UL, 22526811443298304UL, 9024825867763712UL, 18049651735527936UL};

u64 rookMagics[BOARD_SIZE] = {36029352143495184UL, 9277425265429971008UL, 2486031868128919680UL, 108090857827598464UL, 1224987899033829892UL, 1008824064494010880UL, 1297045630543200420UL, 612490648838220928UL, 90212731109605416UL, 141288317919232UL, 4756082956643344386UL, 4616330424270981125UL, 721279662189202432UL, 90634977028375568UL, 577023721684862248UL, 9148092444051712UL, 18020446368694336UL, 1179943652705845256UL, 36733034753437704UL, 72203279597049856UL, 2393087393400832UL, 3170816712224286850UL, 2306128883445924146UL, 4623087954015831043UL, 6950040076793430032UL, 351856607953792UL, 289919372042191232UL, 9511620015930474626UL, 2344125257461530632UL, 216748928357761152UL, 360853445584375841UL, 1170937286097174660UL, 145960210530528UL, 4538785161285632UL, 3472559124158353472UL, 4616330424270981125UL, 721279662189202432UL, 90634977028375568UL, 2508328022017UL, 1152927626042541093UL, 90212731109605416UL, 189151460032790528UL, 1441187074005860416UL, 1152994072912330761UL, 281852967714832UL, 288793343422496848UL, 10520426497853096024UL, 864972605583589378UL, 5260202827150502400UL, 5260202827150502400UL, 5296232809593843200UL, 7007600874156364288UL, 18446743979218685440UL, 18446744030759085568UL, 1125444202439872UL, 5841168673586058912UL, 17005591892296975654UL, 7061642970158444206UL, 6034823423364870562UL, 1333065189051839990UL, 4692750665688806614UL, 5348454054381571UL, 1125827562356340UL, 8522499339677771678UL};
int rookShifts[BOARD_SIZE] = {52, 53, 53, 53, 53, 53, 53, 52, 53, 54, 54, 54, 54, 54, 54, 53, 53, 54, 54, 54, 54, 54, 54, 53, 53, 54, 54, 54, 54, 54, 54, 53, 53, 54, 54, 54, 54, 54, 54, 53, 53, 54, 54, 54, 54, 54, 54, 53, 54, 55, 55, 55, 55, 55, 55, 54, 53, 54, 54, 54, 54, 53, 54, 53};
int rookIndexOffset[BOARD_SIZE] = {0, 4096, 6144, 8192, 10240, 12288, 14336, 16384, 20480, 22528, 23552, 24576, 25600, 26624, 27648, 28672, 30720, 32768, 33792, 34816, 35840, 36864, 37888, 38912, 40960, 43008, 44032, 45056, 46080, 47104, 48128, 49152, 51200, 53248, 54272, 55296, 56320, 57344, 58368, 59392, 61440, 63488, 64512, 65536, 66560, 67584, 68608, 69632, 71680, 72704, 73216, 73728, 74240, 74752, 75264, 75776, 76800, 78848, 79872, 80896, 81920, 82944, 84992, 86016};
#define ROOK_PSEUDO_LEGAL_MOVES_ARRAY_SIZE 88064

u64 bishopMagics[BOARD_SIZE] = {18441670916271046655UL, 18161155296967783798UL, 155382990761886050UL, 9230163170978430979UL, 11543856280344068136UL, 306817079456563232UL, 18161441449164338550UL, 9222806873877118975UL, 18160843177395027958UL, 18160900218856208374UL, 360292385491648513UL, 1130349836894208UL, 18015572109623328UL, 360358923523330048UL, 18160876197363646326UL, 4325813748086734710UL, 8340696151287451643UL, 4728811472401641468UL, 9626444242192957968UL, 11610350568899371008UL, 147493480520810624UL, 10502605445868291345UL, 8938522175157370742UL, 18161331257755361142UL, 36767946932527636UL, 4547666739986560UL, 9225626036968095760UL, 290279726923920UL, 11541573557829632UL, 283674877105152UL, 1197385351430403UL, 4623087954015831043UL, 591880855232516UL, 9296010242024409606UL, 144150578606900352UL, 11529938526870701184UL, 7084173217560010760UL, 6060516682252544UL, 290273217351172UL, 288796908175299717UL, 15920182580465156255UL, 17969356424471207979UL, 9232944385690272256UL, 1152921917863371008UL, 306315154428002816UL, 9224505085768237312UL, 4899804643636939777UL, 5476321683761034753UL, 18163002480944018806UL, 18161881288420947318UL, 441362695872053248UL, 1297353769751286016UL, 13871086921054289920UL, 2305878485914232098UL, 14123209112897096841UL, 14123159053945941129UL, 18446740762247425535UL, 18160875434761549174UL, 72339690242050058UL, 563302209980448UL, 36767946932527636UL, 4611721477747130508UL, 18160904646992000822UL, 4899808981553917065UL};
int bishopShifts[BOARD_SIZE] = {59, 60, 59, 59, 59, 59, 60, 59, 60, 60, 59, 59, 59, 59, 60, 60, 60, 60, 57, 57, 57, 57, 60, 60, 59, 59, 57, 55, 55, 57, 59, 59, 59, 59, 57, 55, 55, 57, 59, 59, 60, 60, 57, 57, 57, 57, 60, 60, 60, 60, 59, 59, 59, 59, 60, 60, 59, 60, 59, 59, 59, 59, 60, 59};
int bishopIndexOffset[BOARD_SIZE] = {0, 32, 48, 80, 112, 144, 176, 192, 224, 240, 256, 288, 320, 352, 384, 400, 416, 432, 448, 576, 704, 832, 960, 976, 992, 1024, 1056, 1184, 1696, 2208, 2336, 2368, 2400, 2432, 2464, 2592, 3104, 3616, 3744, 3776, 3808, 3824, 3840, 3968, 4096, 4224, 4352, 4368, 4384, 4400, 4416, 4448, 4480, 4512, 4544, 4560, 4576, 4608, 4624, 4656, 4688, 4720, 4752, 4768};
#define BISHOP_PSEUDO_LEGAL_MOVES_ARRAY_SIZE 4800

// The total size of these two arrays is 742.912kb
// We don't want that much on the stack so these arrays are allocated on the heap
u64* rookPseudoLegalMovesBitBoard;
u64* bishopPseudoLegalMovesBitBoard;

u64 getRookPseudoLegalMovesBitBoard(int position, u64 blockingBitBoard) {
    u64 magic = rookMagics[position];
    int shift = rookShifts[position];
    u64 key = (blockingBitBoard * magic) >> shift;
    u64 offset = (u64) rookIndexOffset[position];
    u64 indexIntoPseudoLegalMovesArray = offset + key;
    return rookPseudoLegalMovesBitBoard[indexIntoPseudoLegalMovesArray];
}

u64 getBishopPseudoLegalMovesBitBoard(int position, u64 blockingBitBoard) {
    u64 magic = bishopMagics[position];
    int shift = bishopShifts[position];
    u64 key = (blockingBitBoard * magic) >> shift;
    u64 offset = (u64) bishopIndexOffset[position];
    u64 indexIntoPseudoLegalMovesArray = offset + key;
    return bishopPseudoLegalMovesBitBoard[indexIntoPseudoLegalMovesArray];
}

void magicBitBoardInitialize() {
    rookPseudoLegalMovesBitBoard = calloc(ROOK_PSEUDO_LEGAL_MOVES_ARRAY_SIZE, sizeof(u64));
    bishopPseudoLegalMovesBitBoard = calloc(BISHOP_PSEUDO_LEGAL_MOVES_ARRAY_SIZE, sizeof(u64));
    // The max number of valid squares for a piece is 12
    // Thus the max number of blocking bit board 2^12 = 1 << 12
    u64* blockingBitBoards = malloc((1 << 12) * sizeof(u64));
    u64* blockingBitBoardToPseudoLegalMove = malloc((1 << 12) * sizeof(u64));

    // Filling the rook pseudo legal moves bit board array
    for (int position = 0; position < BOARD_SIZE; position++) {
        u64 magic = rookMagics[position];
        int shift = rookShifts[position];
        u64 offset = (u64) rookIndexOffset[position];
        
        int numBlockingBitBoard = 1 << minShiftRook[position];
        fillRookBlockingBitBoardAndPseudoLegalMoveArray(position, blockingBitBoards, blockingBitBoardToPseudoLegalMove);
        for (int i = 0; i < numBlockingBitBoard; i++) {
            u64 blockingBitBoard = blockingBitBoards[i];
            u64 pseudoLegalMovesBitBoard = blockingBitBoardToPseudoLegalMove[i];

            u64 key = (blockingBitBoard * magic) >> shift;
            u64 indexIntoPseudoLegalMovesArray = offset + key;

            u64 nextIndex = position == 63 ? ROOK_PSEUDO_LEGAL_MOVES_ARRAY_SIZE : rookIndexOffset[position + 1];

            rookPseudoLegalMovesBitBoard[indexIntoPseudoLegalMovesArray] = pseudoLegalMovesBitBoard;
        }
    }

    for (int position = 0; position < BOARD_SIZE; position++) {
        u64 magic = bishopMagics[position];
        int shift = bishopShifts[position];
        u64 offset = (u64) bishopIndexOffset[position];
        
        int numBlockingBitBoard = 1 << minShiftBishop[position];
        fillBishopBlockingBitBoardAndPseudoLegalMoveArray(position, blockingBitBoards, blockingBitBoardToPseudoLegalMove);
        for (int i = 0; i < numBlockingBitBoard; i++) {
            u64 blockingBitBoard = blockingBitBoards[i];
            u64 pseudoLegalMovesBitBoard = blockingBitBoardToPseudoLegalMove[i];

            u64 key = (blockingBitBoard * magic) >> shift;
            u64 indexIntoPseudoLegalMovesArray = offset + key;

            bishopPseudoLegalMovesBitBoard[indexIntoPseudoLegalMovesArray] = pseudoLegalMovesBitBoard;
        }
    }
    free(blockingBitBoards);
    free(blockingBitBoardToPseudoLegalMove);
}

void magicBitBoardTerminate() {
    free(rookPseudoLegalMovesBitBoard);
    free(bishopPseudoLegalMovesBitBoard);
}